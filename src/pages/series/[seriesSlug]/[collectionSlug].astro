---
import type { GetStaticPaths } from 'astro';
import { format } from 'date-fns';
import { getCollections } from '../../../../db/interface';
import Layout from '../../../layouts/default.astro';
import EpisodePreview from '../../../components/episode-preview.astro';

export const getStaticPaths = (async () => {
	const collections = await getCollections();

	return collections.map((collection) => {
		if (!collection.parent || !collection.parent.fields) {
			return { params: {} };
		}

		return {
			params: {
				seriesSlug: collection.parent.fields.slug,
				collectionSlug: collection.fields.slug,
			},
			props: {
				collection: collection.fields,
				series: collection.parent.fields,
				episodes: collection.resources,
			},
		};
	});
}) satisfies GetStaticPaths;

const { collection, series, episodes } = Astro.props;
---

<Layout>
	<header>
		<div class="series-info">
			<svg
				xmlns="http://www.w3.org/2000/svg"
				fill="none"
				viewBox="0 0 57 30"
				class="production-co"
				><title>LWJ Original</title><path
					fill="color(display-p3 .9804 .9765 .9922)"
					fill-rule="evenodd"
					d="M2.17391 0C.973294 0 0 .973294 0 2.17391V27.8261C0 29.0267.973296 30 2.17391 30H54.3478c1.2007 0 2.1739-.9733 2.1739-2.1739V2.17391C56.5217.973294 55.5485 0 54.3478 0H2.17391ZM46.8906 12.5881c0 1.3826-.9652 2.3479-2.4 2.3479-1.1739 0-2.1913-.3131-3.4173-1.0435l-.0783.0522.6522 5.713c1.4348.7043 2.8956 1.0435 4.6434 1.0435 2.1913 0 3.9392-.6 5.2174-1.8 1.2783-1.2 1.9044-2.8435 1.9044-4.9044V2.23162h-6.5218V12.5881ZM28.8777 14.675l-3 5.9478h-6.0261L14.6864 2.23154h6.9391l2.2956 9.52176 4.8783-9.75654h.3391l4.8522 9.75654 2.2957-9.52176h6.7565L37.8777 20.6228h-6.0261l-2.9739-5.9478Zm-12.1486 5.8175v-5.8174H9.94645V2.23162H3.42471V20.4925H16.7291Zm36.5877 6.2886v.8843h-3.2635v-5.4782h.9861v4.5939h2.2774Zm-9.6793-1.229 1.0173-2.3087.9783 2.3087h-1.9956Zm3.9443 2.113-2.4104-5.5017h-.9783l-2.4887 5.5017h1.0174l.5635-1.2756h2.6922l.5399 1.2756h1.0644Zm-8.345-5.4779v5.5095h-.4852l-3.5765-4.0617.0078 4.0304h-.9548v-5.4782h.9313l3.1305 3.553-.0079-3.553h.9548Zm-8.04 5.4782v-5.4782h-.9861v5.4782h.9861Zm-6.316-2.9195h2.3478v2.3322c-.7278.4617-1.44.6652-2.2774.6652-.8452 0-1.5261-.2582-2.0504-.7669-.5244-.5087-.7826-1.1896-.7826-2.027 0-.8296.2895-1.5104.8609-2.0426.5713-.5322 1.2991-.7983 2.1834-.7983.6966 0 1.2913.1331 1.9252.4461v1.0409c-.7278-.407-1.3069-.5713-1.9252-.5713-.5791 0-1.0643.18-1.4478.5478-.3913.3678-.587.8218-.587 1.3618 0 .5713.18 1.033.5322 1.3852.3522.3522.8139.5322 1.3852.5322.4774 0 .8687-.0783 1.2444-.2661V25.552h-1.4087v-.8061Zm-5.4733 2.9195v-5.4782h-.9861v5.4782h.9861Zm-5.9897-4.6408h-.72v1.7452h.6887c.6026 0 1.0252-.36 1.0252-.8922 0-.5087-.3991-.853-.9939-.853Zm.7982 2.3791 1.9566 2.2617h-1.2053l-1.7765-2.0974h-.4774v2.0974h-.9861v-5.4782h1.7374c1.1896 0 1.9409.626 1.9409 1.6591 0 .72-.4461 1.3069-1.1896 1.5574ZM4.12085 26.9531c.54783.5478 1.2287.8217 2.05044.8217.82173 0 1.51043-.2739 2.06608-.8295.55565-.5479.82957-1.2209.82957-2.027s-.27392-1.4791-.82174-2.0269c-.55565-.54-1.23652-.814-2.05826-.814-.81392 0-1.49479.274-2.05044.8218-.55565.5556-.83739 1.2287-.83739 2.0348 0 .8061.27391 1.4791.82174 2.0191Zm.72783-3.4122c.35217-.3678.79043-.5556 1.30695-.5556.52435 0 .97826.1878 1.34609.5634.36783.3835.54783.8453.54783 1.3853 0 .54-.18.9939-.54783 1.3695-.36783.3757-.80609.5635-1.33043.5635-.52435 0-.96261-.1878-1.32261-.5635-.36-.3756-.54-.8374-.54-1.3852 0-.54.18-1.0017.54-1.3774Z"
					clip-rule="evenodd"></path></svg
			>
			<h1>{series.title}</h1>
			<p>{series.description}</p>
			<button class="play-episode button">Start watching</button>
		</div>
		<img src={series.banner_image} alt={series.title} />
	</header>

	<section class="collection">
		<div class="collection-info">
			<select>
				<option value={collection.slug} selected>{collection.name}</option>
			</select>
			<p class="year">
				Release year: {format(collection.release_year, 'yyyy')}
			</p>
		</div>
		<div class="episodes">
			{
				episodes.map((ep, index) => {
					const episode = ep.fields;

					if (!episode || !episode.slug) {
						return null;
					}
					return (
						<EpisodePreview
							episode={episode}
							episodeNumber={`${collection.slug} E${ep.position + 1}`}
							episodeUrl={`/series/${series.slug}/${collection.slug}/${episode.slug}`}
						/>
					);
				})
			}
		</div>
	</section>
</Layout>

<style>
	header {
		align-items: end;
		block-size: 60dvh;
		display: flex;
		inline-size: 100cqw;
		padding: 4rem max(calc((100cqw - 1024px) / 2), 5cqw);
		position: relative;

		&::after {
			background-image: linear-gradient(
				10deg in oklch,
				oklch(16.13% 0.08 291.17 / 0.9),
				oklch(16.13% 0.08 291.17 / 0.9) 30%,
				oklch(16.13% 0.08 291.17 / 0.75) 43%,
				oklch(16.13% 0.08 291.17 / 0) 65%
			);
			mix-blend-mode: multiply;
			content: '';
			display: block;
			inset: 0;
			position: absolute;
			z-index: 2;
		}

		& .series-info {
			color: white;
			font-family: mallory-light;
			font-size: 0.875rem;
			line-height: 1.25;
			inline-size: 40ch;
			position: relative;
			z-index: 10;

			& h1 {
				font-size: 2rem;
				line-height: 1.1;
				padding-block: 0.5rem;
			}
		}

		& img {
			block-size: 100%;
			inline-size: 100%;
			display: block;
			inset: 0;
			object-fit: cover;
			position: absolute;
			z-index: 1;
		}
	}

	.production-co {
		inline-size: 3.5rem;
		opacity: 0.75;
	}

	.collection {
		padding: 4rem max(calc((100cqw - 1024px) / 2), 5cqw);
	}

	.collection-info {
		display: flex;
		font-family: mallory-light;
		gap: 1rem;

		& select {
			border: none;
			font-family: mallory-medium, system-ui, sans-serif;
			font-size: 1rem;
		}
	}

	.episodes {
		display: flex;
		flex-wrap: wrap;
		gap: 2rem;
		padding-block-start: 2rem;
	}
</style>
